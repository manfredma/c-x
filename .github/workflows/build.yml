name: KV Storage Server - Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-macos:
    name: Build on macOS
    runs-on: macos-latest
    strategy:
      matrix:
        build_type: [Debug, Release]
        compiler: [clang, gcc]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Install dependencies
      run: |
        # å®‰è£…å¿…è¦çš„å·¥å…·
        brew update
        brew install cmake ninja
        if [ "${{ matrix.compiler }}" = "gcc" ]; then
          brew install gcc
        fi

    - name: Setup compiler
      run: |
        if [ "${{ matrix.compiler }}" = "gcc" ]; then
          echo "CC=gcc-13" >> $GITHUB_ENV
          echo "CXX=g++-13" >> $GITHUB_ENV
        else
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
        fi

    - name: Configure CMake
      run: |
        cmake -B ${{github.workspace}}/build \
          -DCMAKE_BUILD_TYPE=${{matrix.build_type}} \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_CXX_COMPILER=$CXX \
          -G Ninja

    - name: Build
      run: |
        cmake --build ${{github.workspace}}/build --config ${{matrix.build_type}} --parallel

    - name: Create web directory
      run: |
        mkdir -p ${{github.workspace}}/build/web
        cp -r ${{github.workspace}}/web/* ${{github.workspace}}/build/web/

    - name: Run basic tests
      working-directory: ${{github.workspace}}/build
      run: |
        # æµ‹è¯•ç¨‹åºæ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨
        timeout 5s ./c_x --help || true

        # æµ‹è¯•ç¨‹åºæ˜¯å¦èƒ½åœ¨åå°å¯åŠ¨
        ./c_x 8080 &
        SERVER_PID=$!
        sleep 2

        # æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
        curl -f http://localhost:8080/health || exit 1

        # æµ‹è¯• API åŠŸèƒ½
        curl -f -X POST http://localhost:8080/api/test -d 'test_value' || exit 1
        curl -f http://localhost:8080/api/test | grep -q 'test_value' || exit 1
        curl -f -X DELETE http://localhost:8080/api/test || exit 1

        # æµ‹è¯• Web é¡µé¢
        curl -f -o /dev/null http://localhost:8080/web/ || exit 1

        # åœæ­¢æœåŠ¡å™¨
        kill $SERVER_PID
        wait $SERVER_PID 2>/dev/null || true

        echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"

    - name: Run performance test
      if: matrix.build_type == 'Release'
      working-directory: ${{github.workspace}}/build
      run: |
        # å¯åŠ¨æœåŠ¡å™¨
        ./c_x 8080 &
        SERVER_PID=$!
        sleep 2

        # æ€§èƒ½æµ‹è¯•
        echo "ğŸš€ è¿è¡Œæ€§èƒ½æµ‹è¯•..."

        # å¹¶å‘æµ‹è¯•
        for i in {1..10}; do
          curl -s -X POST http://localhost:8080/api/perf_test_$i -d "performance_test_data_$i" &
        done
        wait

        # éªŒè¯æ•°æ®
        for i in {1..10}; do
          curl -s http://localhost:8080/api/perf_test_$i | grep -q "performance_test_data_$i" || exit 1
        done

        # æ¸…ç†æ•°æ®
        for i in {1..10}; do
          curl -s -X DELETE http://localhost:8080/api/perf_test_$i &
        done
        wait

        # åœæ­¢æœåŠ¡å™¨
        kill $SERVER_PID
        wait $SERVER_PID 2>/dev/null || true

        echo "âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡ï¼"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      if: matrix.build_type == 'Release' && matrix.compiler == 'clang'
      with:
        name: kv-server-macos-${{ matrix.build_type }}
        path: |
          ${{github.workspace}}/build/c_x
          ${{github.workspace}}/build/web/
        retention-days: 30

  security-scan:
    name: Security Scan
    runs-on: macos-latest
    needs: build-macos

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run static analysis
      run: |
        # å®‰è£…é™æ€åˆ†æå·¥å…·
        brew install cppcheck clang-format

        # è¿è¡Œ cppcheck
        echo "ğŸ” è¿è¡Œ cppcheck é™æ€åˆ†æ..."
        cppcheck --enable=all --error-exitcode=1 --suppress=missingIncludeSystem src/ include/ || true

        # æ£€æŸ¥ä»£ç æ ¼å¼
        echo "ğŸ“ æ£€æŸ¥ä»£ç æ ¼å¼..."
        find src include -name "*.c" -o -name "*.h" | xargs clang-format --dry-run --Werror || true

    - name: Check for security issues
      run: |
        echo "ğŸ›¡ï¸ æ£€æŸ¥å®‰å…¨é—®é¢˜..."

        # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†ä¸å®‰å…¨çš„å‡½æ•°
        if grep -r "strcpy\|strcat\|sprintf\|gets" src/ include/; then
          echo "âŒ å‘ç°ä¸å®‰å…¨çš„å‡½æ•°è°ƒç”¨"
          exit 1
        fi

        # æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„å¯†ç æˆ–å¯†é’¥
        if grep -ri "password\|secret\|key.*=" src/ include/ | grep -v "test\|example"; then
          echo "âš ï¸ å¯èƒ½å­˜åœ¨ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯"
        fi

        echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡ï¼"

  integration-test:
    name: Integration Test
    runs-on: macos-latest
    needs: build-macos

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup environment
      run: |
        brew install cmake ninja curl

    - name: Build project
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -G Ninja
        cmake --build build --parallel
        mkdir -p build/web
        cp -r web/* build/web/

    - name: Run integration tests
      working-directory: build
      run: |
        # å¯åŠ¨æœåŠ¡å™¨
        ./c_x 9000 &
        SERVER_PID=$!
        sleep 3

        # è¿è¡Œé›†æˆæµ‹è¯•è„šæœ¬
        if [ -f "../test_all_endpoints.sh" ]; then
          chmod +x ../test_all_endpoints.sh
          sed -i '' 's/8080/9000/g' ../test_all_endpoints.sh
          ../test_all_endpoints.sh
        fi

        # æµ‹è¯•åŠ¨æ€ç«¯å£åŠŸèƒ½
        if [ -f "../test_dynamic_port.sh" ]; then
          chmod +x ../test_dynamic_port.sh
          sed -i '' 's/8080/9000/g' ../test_dynamic_port.sh
          ../test_dynamic_port.sh
        fi

        # æµ‹è¯• CORS åŠŸèƒ½
        if [ -f "../test_cors_and_hosts.sh" ]; then
          chmod +x ../test_cors_and_hosts.sh
          sed -i '' 's/8080/9000/g' ../test_cors_and_hosts.sh
          ../test_cors_and_hosts.sh
        fi

        # åœæ­¢æœåŠ¡å™¨
        kill $SERVER_PID
        wait $SERVER_PID 2>/dev/null || true

        echo "âœ… é›†æˆæµ‹è¯•å®Œæˆï¼"

  release:
    name: Create Release
    runs-on: macos-latest
    needs: [build-macos, security-scan, integration-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build release version
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -G Ninja
        cmake --build build --parallel
        mkdir -p build/web
        cp -r web/* build/web/

    - name: Create release package
      run: |
        mkdir -p release
        cp build/c_x release/
        cp -r build/web release/
        cp README.md release/ 2>/dev/null || echo "# KV Storage Server" > release/README.md
        cp start_server.sh release/ 2>/dev/null || true

        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > release/start.sh << 'EOF'
        #!/bin/bash
        echo "ğŸš€ å¯åŠ¨ KV å­˜å‚¨æœåŠ¡å™¨..."
        ./c_x 8080
        EOF
        chmod +x release/start.sh

        # æ‰“åŒ…
        tar -czf kv-server-macos.tar.gz -C release .

    - name: Upload release artifact
      uses: actions/upload-artifact@v3
      with:
        name: kv-server-release-macos
        path: kv-server-macos.tar.gz
        retention-days: 90

