name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-format:
    name: Code Format Check
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install clang-format
      run: |
        brew install clang-format

    - name: Check code formatting
      run: |
        echo "ğŸ“ æ£€æŸ¥ C ä»£ç æ ¼å¼..."

        # æ£€æŸ¥æ‰€æœ‰ C å’Œå¤´æ–‡ä»¶çš„æ ¼å¼
        find src include -name "*.c" -o -name "*.h" | while read file; do
          echo "æ£€æŸ¥æ–‡ä»¶: $file"
          if ! clang-format --dry-run --Werror "$file" > /dev/null 2>&1; then
            echo "âŒ æ–‡ä»¶ $file æ ¼å¼ä¸ç¬¦åˆè§„èŒƒ"
            echo "å»ºè®®çš„æ ¼å¼åŒ–å†…å®¹:"
            clang-format "$file"
            exit 1
          fi
        done

        echo "âœ… æ‰€æœ‰æ–‡ä»¶æ ¼å¼æ£€æŸ¥é€šè¿‡ï¼"

    - name: Check line endings
      run: |
        echo "ğŸ” æ£€æŸ¥è¡Œç»“æŸç¬¦..."

        # æ£€æŸ¥æ˜¯å¦æœ‰ Windows é£æ ¼çš„è¡Œç»“æŸç¬¦
        if find src include web -type f \( -name "*.c" -o -name "*.h" -o -name "*.html" -o -name "*.js" -o -name "*.css" \) -exec grep -l $'\r' {} \; | head -1; then
          echo "âŒ å‘ç° Windows é£æ ¼çš„è¡Œç»“æŸç¬¦ (CRLF)"
          echo "è¯·ä½¿ç”¨ Unix é£æ ¼çš„è¡Œç»“æŸç¬¦ (LF)"
          exit 1
        fi

        echo "âœ… è¡Œç»“æŸç¬¦æ£€æŸ¥é€šè¿‡ï¼"

  static-analysis:
    name: Static Analysis
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install analysis tools
      run: |
        brew install cppcheck scan-build

    - name: Run cppcheck
      run: |
        echo "ğŸ” è¿è¡Œ cppcheck é™æ€åˆ†æ..."

        cppcheck \
          --enable=all \
          --error-exitcode=1 \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --suppress=unmatchedSuppression \
          --inline-suppr \
          --std=c99 \
          --platform=unix64 \
          --check-config \
          src/ include/ 2>&1 | tee cppcheck-report.txt

        echo "âœ… cppcheck åˆ†æå®Œæˆï¼"

    - name: Run scan-build (Clang Static Analyzer)
      run: |
        echo "ğŸ” è¿è¡Œ Clang é™æ€åˆ†æå™¨..."

        # æ¸…ç†ä¹‹å‰çš„æ„å»º
        rm -rf build

        # ä½¿ç”¨ scan-build è¿›è¡Œé™æ€åˆ†æ
        scan-build \
          --status-bugs \
          --view-background \
          cmake -B build -DCMAKE_BUILD_TYPE=Debug

        scan-build \
          --status-bugs \
          --view-background \
          cmake --build build

        echo "âœ… Clang é™æ€åˆ†æå®Œæˆï¼"

    - name: Upload analysis reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: static-analysis-reports
        path: |
          cppcheck-report.txt
          /tmp/scan-build-*
        retention-days: 7

  security-check:
    name: Security Check
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for unsafe functions
      run: |
        echo "ğŸ›¡ï¸ æ£€æŸ¥ä¸å®‰å…¨çš„å‡½æ•°è°ƒç”¨..."

        # å®šä¹‰ä¸å®‰å…¨çš„å‡½æ•°åˆ—è¡¨
        UNSAFE_FUNCTIONS=(
          "strcpy" "strcat" "sprintf" "vsprintf"
          "gets" "scanf" "fscanf" "sscanf"
          "strncpy" "strncat" "snprintf" "vsnprintf"
        )

        FOUND_ISSUES=0

        for func in "${UNSAFE_FUNCTIONS[@]}"; do
          if grep -rn "\b$func\s*(" src/ include/; then
            echo "âš ï¸ å‘ç°å¯èƒ½ä¸å®‰å…¨çš„å‡½æ•°: $func"
            FOUND_ISSUES=1
          fi
        done

        if [ $FOUND_ISSUES -eq 1 ]; then
          echo "âŒ å‘ç°æ½œåœ¨çš„å®‰å…¨é—®é¢˜"
          echo "å»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„æ›¿ä»£å‡½æ•°"
          exit 1
        fi

        echo "âœ… æœªå‘ç°ä¸å®‰å…¨çš„å‡½æ•°è°ƒç”¨ï¼"

    - name: Check for hardcoded secrets
      run: |
        echo "ğŸ” æ£€æŸ¥ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯..."

        # æ£€æŸ¥å¯èƒ½çš„ç¡¬ç¼–ç å¯†ç ã€å¯†é’¥ç­‰
        PATTERNS=(
          "password\s*=\s*[\"'][^\"']+[\"']"
          "secret\s*=\s*[\"'][^\"']+[\"']"
          "key\s*=\s*[\"'][^\"']+[\"']"
          "token\s*=\s*[\"'][^\"']+[\"']"
          "api_key\s*=\s*[\"'][^\"']+[\"']"
        )

        FOUND_SECRETS=0

        for pattern in "${PATTERNS[@]}"; do
          if grep -rniE "$pattern" src/ include/ | grep -v "test\|example\|demo"; then
            echo "âš ï¸ å‘ç°å¯èƒ½çš„ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯"
            FOUND_SECRETS=1
          fi
        done

        if [ $FOUND_SECRETS -eq 1 ]; then
          echo "âŒ å‘ç°æ½œåœ¨çš„ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯"
          echo "è¯·ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶"
          exit 1
        fi

        echo "âœ… æœªå‘ç°ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯ï¼"

    - name: Check file permissions
      run: |
        echo "ğŸ”’ æ£€æŸ¥æ–‡ä»¶æƒé™..."

        # æ£€æŸ¥æ˜¯å¦æœ‰å¯æ‰§è¡Œçš„æºæ–‡ä»¶
        if find src include -name "*.c" -o -name "*.h" | xargs ls -la | grep "^-rwxr"; then
          echo "âš ï¸ å‘ç°å¯æ‰§è¡Œçš„æºæ–‡ä»¶"
          echo "æºæ–‡ä»¶ä¸åº”è¯¥æœ‰æ‰§è¡Œæƒé™"
          exit 1
        fi

        # æ£€æŸ¥è„šæœ¬æ–‡ä»¶æƒé™
        find . -name "*.sh" | while read script; do
          if [ ! -x "$script" ]; then
            echo "âš ï¸ è„šæœ¬æ–‡ä»¶ $script æ²¡æœ‰æ‰§è¡Œæƒé™"
          fi
        done

        echo "âœ… æ–‡ä»¶æƒé™æ£€æŸ¥é€šè¿‡ï¼"

  documentation-check:
    name: Documentation Check
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check README
      run: |
        echo "ğŸ“š æ£€æŸ¥æ–‡æ¡£å®Œæ•´æ€§..."

        if [ ! -f "README.md" ]; then
          echo "âŒ ç¼ºå°‘ README.md æ–‡ä»¶"
          exit 1
        fi

        # æ£€æŸ¥ README æ˜¯å¦åŒ…å«åŸºæœ¬ä¿¡æ¯
        REQUIRED_SECTIONS=(
          "# KV Storage Server"
          "## åŠŸèƒ½ç‰¹æ€§"
          "## å¿«é€Ÿå¼€å§‹"
          "## API æ–‡æ¡£"
        )

        for section in "${REQUIRED_SECTIONS[@]}"; do
          if ! grep -q "$section" README.md; then
            echo "âš ï¸ README.md ç¼ºå°‘ç« èŠ‚: $section"
          fi
        done

        echo "âœ… æ–‡æ¡£æ£€æŸ¥å®Œæˆï¼"

    - name: Check code comments
      run: |
        echo "ğŸ’¬ æ£€æŸ¥ä»£ç æ³¨é‡Šè¦†ç›–ç‡..."

        # ç»Ÿè®¡å‡½æ•°å’Œæ³¨é‡Š
        TOTAL_FUNCTIONS=$(grep -r "^[a-zA-Z_][a-zA-Z0-9_]*\s*(" src/ include/ | wc -l)
        COMMENTED_FUNCTIONS=$(grep -B1 -r "^[a-zA-Z_][a-zA-Z0-9_]*\s*(" src/ include/ | grep -c "//\|/\*" || echo 0)

        if [ $TOTAL_FUNCTIONS -gt 0 ]; then
          COMMENT_RATIO=$((COMMENTED_FUNCTIONS * 100 / TOTAL_FUNCTIONS))
          echo "å‡½æ•°æ€»æ•°: $TOTAL_FUNCTIONS"
          echo "æœ‰æ³¨é‡Šçš„å‡½æ•°: $COMMENTED_FUNCTIONS"
          echo "æ³¨é‡Šè¦†ç›–ç‡: $COMMENT_RATIO%"

          if [ $COMMENT_RATIO -lt 50 ]; then
            echo "âš ï¸ æ³¨é‡Šè¦†ç›–ç‡è¾ƒä½ï¼Œå»ºè®®å¢åŠ ä»£ç æ³¨é‡Š"
          fi
        fi

        echo "âœ… æ³¨é‡Šæ£€æŸ¥å®Œæˆï¼"

  dependency-check:
    name: Dependency Check
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check CMake dependencies
      run: |
        echo "ğŸ“¦ æ£€æŸ¥ CMake ä¾èµ–..."

        if [ -f "CMakeLists.txt" ]; then
          # æ£€æŸ¥ CMake æœ€ä½ç‰ˆæœ¬è¦æ±‚
          CMAKE_VERSION=$(grep "cmake_minimum_required" CMakeLists.txt | grep -o "[0-9]\+\.[0-9]\+")
          echo "CMake æœ€ä½ç‰ˆæœ¬è¦æ±‚: $CMAKE_VERSION"

          # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å¤–éƒ¨ä¾èµ–
          if grep -q "find_package\|FetchContent" CMakeLists.txt; then
            echo "å‘ç°å¤–éƒ¨ä¾èµ–:"
            grep "find_package\|FetchContent" CMakeLists.txt
          fi
        fi

        echo "âœ… ä¾èµ–æ£€æŸ¥å®Œæˆï¼"

    - name: Check system requirements
      run: |
        echo "ğŸ–¥ï¸ æ£€æŸ¥ç³»ç»Ÿè¦æ±‚..."

        # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº† macOS ç‰¹å®šçš„åŠŸèƒ½
        if grep -r "kqueue\|kevent" src/ include/; then
          echo "âœ… æ£€æµ‹åˆ° kqueue ä½¿ç”¨ (macOS/BSD ç‰¹æ€§)"
        fi

        # æ£€æŸ¥ C æ ‡å‡†
        if grep -r "c99\|c11\|c17" CMakeLists.txt; then
          echo "âœ… æŒ‡å®šäº† C æ ‡å‡†"
        fi

        echo "âœ… ç³»ç»Ÿè¦æ±‚æ£€æŸ¥å®Œæˆï¼"

